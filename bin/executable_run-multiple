#!/usr/bin/env python3

import os
import sys
import subprocess
import time
from typing import List, Optional
from dataclasses import dataclass

# --- Virtual Environment Auto-Activation ---
script_dir = os.path.dirname(os.path.abspath(__file__))
virtual_env_python = os.path.join(script_dir, ".venv", "bin", "python3")

if os.path.exists(virtual_env_python) and os.path.abspath(
    sys.executable
) != os.path.abspath(virtual_env_python):
    try:
        os.execv(virtual_env_python, [virtual_env_python] + sys.argv)
    except OSError:
        pass

# --- Imports ---
try:
    import typer
    from rich.console import Console
    from rich.theme import Theme
    from rich.panel import Panel
    from rich.rule import Rule
    from rich.table import Table
except ImportError as e:
    print(
        f"Error: Missing dependencies. Ensure you are running in the virtual environment or have installed requirements.\nDetails: {e}",
        file=sys.stderr,
    )
    sys.exit(1)

# --- Configuration & Styling ---
custom_theme = Theme(
    {
        "info": "bold blue",
        "success": "bold green",
        "error": "bold red",
        "warning": "bold yellow",
        "cmd": "bold cyan",
        "dim": "dim white",
        "border": "cyan",
        "fail_border": "red",
    }
)

console = Console(theme=custom_theme)
app = typer.Typer(
    add_completion=False,
    help="Run multiple commands sequentially with visual feedback.",
)


@dataclass
class CommandResult:
    command: str
    status: str
    duration: float
    error: Optional[str] = None


def print_output_line(line: str, style: str = "dim"):
    """Prints a line with a vertical bar prefix."""
    console.print(f"[{style}]│[/] {line}", end="")


@app.command()
def main(
    commands: List[str] = typer.Argument(
        ..., help="The shell commands to execute sequentially."
    ),
    env_vars: List[str] = typer.Option(
        None, "--env", "-e", help="Environment variables to set (KEY=VALUE)."
    ),
    dry_run: bool = typer.Option(
        False, "--dry-run", help="Print commands without executing them."
    ),
):
    """
    Run multiple commands one after another. Stops on the first failure.
    """
    total = len(commands)

    # Parse env vars
    extra_env = os.environ.copy()
    if env_vars:
        for item in env_vars:
            if "=" in item:
                k, v = item.split("=", 1)
                extra_env[k] = v

    results: List[CommandResult] = []

    # Header for the whole run
    if dry_run:
        console.print(
            Panel(
                "[warning]DRY RUN MODE: No commands will be executed.[/]",
                border_style="warning",
            )
        )

    failed = False

    for i, cmd in enumerate(commands):
        step_num = i + 1
        start_time = time.time()

        # Header
        console.print(Rule(f"[info]Step {step_num}/{total}[/]", style="border"))
        console.print(f"[{'border'}]╭─ Running: [/][cmd]{cmd}[/]")

        if dry_run:
            console.print(f"[{'border'}]│[/] [dim](Dry Run) Would execute: {cmd}[/]")
            duration = 0.0
            results.append(CommandResult(cmd, "Skipped (Dry Run)", duration))
            console.print(f"[{'border'}]╰─ [success]✔ Dry Run OK[/]\n")
            continue

        return_code = 0
        try:
            # Run command, merge stdout and stderr
            process = subprocess.Popen(
                cmd,
                shell=True,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                bufsize=1,  # Line buffered
                executable="/bin/bash",
                env=extra_env,
            )

            # Stream output
            with process.stdout:
                for line in iter(process.stdout.readline, ""):
                    print_output_line(line, "border")

            process.wait()
            return_code = process.returncode

        except Exception as e:
            console.print(f"[{'fail_border'}]│[/] [error]Execution Error:[/]: {e}")
            return_code = 1

        duration = time.time() - start_time
        success = return_code == 0

        # Footer
        if success:
            console.print(
                f"[{'border'}]╰─ [success]✔ Success[/] [dim]({duration:.2f}s)[/]"
            )
            results.append(CommandResult(cmd, "Success", duration))
            console.print("")  # Spacer
        else:
            console.print(
                f"[{'fail_border'}]╰─ [error]✖ Failed[/] [dim]({duration:.2f}s)[/]"
            )
            results.append(CommandResult(cmd, "Failed", duration))
            console.print(
                f"\n[error]Command failed with exit code {return_code}:[/] [cmd]{cmd}[/]"
            )

            remaining = commands[i + 1 :]
            if remaining:
                console.print(
                    Panel(
                        "\n".join([f"- {c}" for c in remaining]),
                        title="[warning]⚠ Skipped subsequent commands[/]",
                        border_style="warning",
                        expand=False,
                    )
                )

            # Record skipped for summary
            for skipped in remaining:
                results.append(CommandResult(skipped, "Skipped", 0.0))

            failed = True
            break

    # Summary Table
    if not dry_run:
        table = Table(title="Execution Summary", box=None)
        table.add_column("#", justify="right", style="dim")
        table.add_column("Command", style="cyan")
        table.add_column("Status", style="bold")
        table.add_column("Duration", justify="right")

        for idx, res in enumerate(results):
            status_style = (
                "green"
                if res.status == "Success"
                else "red"
                if res.status == "Failed"
                else "yellow"
            )
            table.add_row(
                str(idx + 1),
                res.command,
                f"[{status_style}]{res.status}[/]",
                f"{res.duration:.2f}s" if res.duration > 0 else "-",
            )

        console.print(
            Panel(table, expand=False, border_style="red" if failed else "green")
        )

    if failed:
        sys.exit(1)
    elif not dry_run:
        console.print("[success]✔ All commands completed successfully.[/]")


if __name__ == "__main__":
    app()

