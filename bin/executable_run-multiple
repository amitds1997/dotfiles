#!/usr/bin/env python3

from utils.common import activate_virtual_env_if_exists

activate_virtual_env_if_exists()

import subprocess
import sys
import time
from dataclasses import dataclass
from typing import List, Optional

import typer
from rich.panel import Panel
from rich.rule import Rule
from rich.table import Table

from utils.console import get_console, get_console_string, ConsoleType

console = get_console()

app = typer.Typer(
    add_completion=False,
    help="Run multiple commands sequentially with visual feedback.",
)


@dataclass
class CommandResult:
    command: str
    status: str
    duration: float
    error: Optional[str] = None


@app.command()
def main(
    commands: List[str] = typer.Argument(
        ..., help="The shell commands to execute sequentially."
    ),
    dry_run: bool = typer.Option(
        False, "--dry-run", help="Print commands without executing them."
    ),
):
    """
    Run multiple commands one after another. Stops on the first failure.
    """
    total_cmd_count = len(commands)

    if dry_run:
        console.print(
            Panel(
                "[warning]DRY RUN MODE: No commands will be executed.[/]",
                border_style="warning",
            )
        )

    results: List[CommandResult] = []
    failed = False

    for i, cmd in enumerate(commands):
        step_num = i + 1
        start_time = time.time()

        console.print(
            Rule(
                get_console_string(
                    ConsoleType.INFO, f"Step {step_num}/{total_cmd_count}"
                ),
                style="border",
            )
        )
        console.print(f"[border]╭─ Running: [/][cmd]{cmd}[/]")

        if dry_run:
            console.print(f"[border]│[/] [dim](Dry Run) Would execute: {cmd}[/]")
            duration = 0.0
            results.append(CommandResult(cmd, "Skipped (Dry Run)", duration))
            console.print("[border]╰─ [success]✔ Dry Run OK[/]\n")
            continue

        return_code = 0
        try:
            process = subprocess.Popen(
                cmd,
                shell=True,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,
                text=True,
                bufsize=1,  # Line buffered
                executable="/bin/bash",
            )

            # Stream output
            with process.stdout:  # ty:ignore[invalid-context-manager]
                for line in iter(process.stdout.readline, ""):  # ty:ignore[possibly-missing-attribute]
                    console.print(f"[border]│[/] {line}", end="")

            process.wait()
            return_code = process.returncode

        except Exception as e:
            console.print(f"[fail_border]│[/] [error]Execution Error:[/]: {e}")
            return_code = 1

        duration = time.time() - start_time
        success = return_code == 0

        # Footer
        if success:
            console.print(f"[border]╰─ [success]✔ Success[/] [dim]({duration:.2f}s)[/]")
            results.append(CommandResult(cmd, "Success", duration))
            console.print("")  # Spacer
        else:
            console.print(
                f"[fail_border]╰─ [error]✖ Failed[/] [dim]({duration:.2f}s)[/]"
            )
            results.append(CommandResult(cmd, "Failed", duration))
            console.print(
                f"\n[error]Command failed with exit code {return_code}:[/] [cmd]{cmd}[/]"
            )

            remaining = commands[i + 1 :]
            if remaining:
                console.print(
                    Panel(
                        "\n".join([f"- {c}" for c in remaining]),
                        title="[warning]⚠ Skipped subsequent commands[/]",
                        border_style="warning",
                        expand=False,
                    )
                )

            # Record skipped for summary
            for skipped in remaining:
                results.append(CommandResult(skipped, "Skipped", 0.0))

            failed = True
            break

    # Summary Table
    if not dry_run:
        table = Table(title="Execution Summary", box=None)
        table.add_column("#", justify="right", style="dim")
        table.add_column("Command", style="cyan")
        table.add_column("Status", style="bold")
        table.add_column("Duration", justify="right")

        for idx, res in enumerate(results):
            status_style = (
                "green"
                if res.status == "Success"
                else "red"
                if res.status == "Failed"
                else "yellow"
            )
            table.add_row(
                str(idx + 1),
                res.command,
                f"[{status_style}]{res.status}[/]",
                f"{res.duration:.2f}s" if res.duration > 0 else "-",
            )

        console.print(
            Panel(table, expand=False, border_style="red" if failed else "green")
        )

    if failed:
        sys.exit(1)
    elif not dry_run:
        console.print("[success]✔ All commands completed successfully.[/]")


if __name__ == "__main__":
    app()
